<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Display</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            font-family: 'Roboto Mono', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #table-stats {
            display: table;
            font-size: 30px;
            font-weight: 500;
            text-align: center;
        }
        .row {
            display: table-row;
        }
        .cell {
            display: table-cell;
            vertical-align: middle;
            padding: 5px 15px; /* Add padding inside cells */
            height: 50px;
        }
        /* Tag cells (1 and 5) */
        .cell.tag {
            background-color: #40E0D0; /* Turquoise */
            text-align: right; /* Right alignment for Cell 1 */
        }
        .cell.tag:last-child {
            text-align: left; /* Left alignment for Cell 5 */
        }
        /* Score cells (2 and 4) */
        .cell.score {
            background-color: #A9A9A9; /* Medium Grey */
            width: 3ch; /* Fixed width for scores */
        }
        .cell.score:nth-child(2) {
            text-align: right; /* Right alignment for Cell 2 */
        }
        .cell.score:nth-child(4) {
            text-align: left; /* Left alignment for Cell 4 */
        }
        /* Race number cell (3) */
        .cell.race {
            background-color: #696969; /* Dark Grey */
            font-size: 15px; /* Half the font size */
            width: 3ch; /* Same width as score cells */
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="table-stats"></div>

    <script>
        // Function to fetch and render data
        async function fetchAndRenderData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const tableId = urlParams.get("tableid");
                const playerName = urlParams.get("name");
                const isWarMode = urlParams.has("war");

                // Apply styling mode based on the presence of the &white parameter
                if (urlParams.has("white")) {
                    document.body.classList.add("white-mode");
                    document.body.classList.remove("dark-mode");
                } else {
                    document.body.classList.add("dark-mode");
                    document.body.classList.remove("white-mode");
                }

                if (!tableId) {
                    document.getElementById("table-stats").innerHTML = "";
                    return;
                }

                const tableResponse = await fetch(`https://mkw-table-bot-api.jprq.site/api/html/full_scores/${tableId}`);
                if (!tableResponse.ok) {
                    document.getElementById("table-stats").innerHTML = "";
                    return;
                }

                const tableHTML = await tableResponse.text();
                const formattedData = parseAndFormatTableData(tableHTML, playerName, isWarMode);
                renderFormattedData(formattedData, isWarMode);
            } catch (error) {
                console.error("Error fetching or rendering data:", error);
                document.getElementById("table-stats").innerHTML = "";
            }
        }

        function parseAndFormatTableData(rawHTML, playerName, isWarMode) {
            const tempElement = document.createElement("div");
            tempElement.innerHTML = rawHTML;

            const raceInfo = tempElement.querySelector(".races_played")?.textContent || "";
            const raceMatch = raceInfo.match(/(\d+)\s*races?/i);
            const raceNumber = raceMatch ? raceMatch[1] : "1";

            const format = tempElement.querySelector(".format")?.textContent.trim() || "Unknown";

            if (!isWarMode || format === "FFA") {
                return parseFFAFormat(tempElement, playerName, raceNumber, format);
            } else {
                const teams = Array.from(tempElement.querySelectorAll(".team_wrapper"));
                if (teams.length !== 2) {
                    return parseFFAFormat(tempElement, playerName, raceNumber, format);
                }

                const teamData = teams.map(team => {
                    const teamName = team.querySelector(".team_name")?.textContent.trim() || "Unknown";
                    const teamScore = team.querySelector(".team_score")?.textContent.trim() || "0";
                    const players = Array.from(team.querySelectorAll(".player_name")).map(player =>
                        player.textContent.trim()
                    );
                    return { name: teamName, score: teamScore, players };
                });

                let [team1, team2] = teamData;
                if (playerName) {
                    const playerTeam = teamData.find(team =>
                        team.players.some(player => player.toLowerCase() === playerName.toLowerCase())
                    );
                    if (playerTeam) {
                        team1 = playerTeam;
                        team2 = teamData.find(team => team !== playerTeam);
                    }
                } else {
                    [team1, team2] = teamData.sort((a, b) => a.name.localeCompare(b.name));
                }

                // Find the largest tag size
                const maxTagLength = Math.max(team1.name.length, team2.name.length);

                return {
                    tag1: team1.name,
                    score1: team1.score,
                    race: raceNumber,
                    score2: team2.score,
                    tag2: team2.name,
                    maxTagLength,
                };
            }
        }

        function renderFormattedData(data, isWarMode) {
            const tableContainer = document.getElementById("table-stats");
            if (!isWarMode || typeof data === "string") {
                tableContainer.innerHTML = data;
                return;
            }

            // Create table row and cells
            const row = document.createElement("div");
            row.className = "row";

            const cellWidth = `${data.maxTagLength + 2}ch`; // Add extra space for padding

            const cell1 = document.createElement("div");
            cell1.className = "cell tag";
            cell1.style.width = cellWidth; // Set width dynamically
            cell1.textContent = data.tag1;

            const cell2 = document.createElement("div");
            cell2.className = "cell score";
            cell2.textContent = data.score1;

            const cell3 = document.createElement("div");
            cell3.className = "cell race";
            cell3.textContent = `R${data.race}`;

            const cell4 = document.createElement("div");
            cell4.className = "cell score";
            cell4.textContent = data.score2;

            const cell5 = document.createElement("div");
            cell5.className = "cell tag";
            cell5.style.width = cellWidth; // Set width dynamically
            cell5.textContent = data.tag2;

            // Append cells to row
            row.appendChild(cell1);
            row.appendChild(cell2);
            row.appendChild(cell3);
            row.appendChild(cell4);
            row.appendChild(cell5);

            // Clear container and append row
            tableContainer.innerHTML = "";
            tableContainer.appendChild(row);
        }

        function parseFFAFormat(tempElement, playerName, raceNumber, format) {
            const players = Array.from(tempElement.querySelectorAll(".player_wrapper")).map(player => {
                const playerName = player.querySelector(".player_name")?.textContent.trim() || "Unknown";
                const playerTotal = parseInt(player.querySelector(".player_total")?.textContent.trim() || "0", 10);
                return { name: playerName, total: playerTotal };
            });

            players.sort((a, b) => b.total - a.total);

            const playerScores = players.map(player => {
                const isMatch = playerName && player.name.toLowerCase() === playerName.toLowerCase();
                return isMatch
                    ? `<span class="text-highlight">${player.total}</span>`
                    : `<span class="text-normal">${player.total}</span>`;
            });

            return `<span class="text-normal">R${raceNumber} ${format}</span> <span class="text-normal">|</span> ${playerScores.join('<span class="text-normal">, </span>')}`;
        }

        document.addEventListener("DOMContentLoaded", fetchAndRenderData);
        setInterval(fetchAndRenderData, 5000);
    </script>
</body>
</html>
