<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lounge Rating</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            font-family: 'Roboto Mono', monospace;
        }
        #player-stats {
            position: absolute;
            top: 10px;
            left: 10px;
            color: black;
            font-size: 30px; /* Base font size */
            font-weight: 500;
        }
        i {
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="player-stats"></div>

    <script>
        async function fetchAndRenderData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const tableId = urlParams.get("tableid");
                const playerName = urlParams.get("name");

                // If 'tableid' is missing, silently stop execution
                if (!tableId) return;

                // Fetch the table data using the 'tableid'
                const tableResponse = await fetch(`https://mkw-table-bot-api.jprq.site/api/html/full_scores/${tableId}`);
                if (!tableResponse.ok) return;

                const tableHTML = await tableResponse.text();

                // Parse and format the table data
                const formattedData = parseAndFormatTableData(tableHTML, playerName);

                // Render the formatted data
                renderFormattedData(formattedData);
            } catch (error) {
                console.error("Error fetching or rendering data:", error);
            }
        }

        function parseAndFormatTableData(rawHTML, playerName) {
            const tempElement = document.createElement("div");
            tempElement.innerHTML = rawHTML;

            const raceInfo = tempElement.querySelector(".races_played")?.textContent || "";
            const raceMatch = raceInfo.match(/(\d+)\s*races?/i);
            const raceNumber = raceMatch ? raceMatch[1] : "1";

            const teams = Array.from(tempElement.querySelectorAll(".team_wrapper"));
            const teamScores = teams.map((team) => {
                const teamName = team.querySelector(".team_name")?.textContent.trim() || "Unknown";
                const teamScore = team.querySelector(".team_score")?.textContent.trim() || "0";
                const players = Array.from(team.querySelectorAll(".player_name")).map(player =>
                    player.textContent.trim()
                );

                // Check if any player's name matches the 'name' parameter
                const isMatch = playerName && players.some(player => player.toLowerCase() === playerName.toLowerCase());
                const formattedTeam = isMatch
                    ? `<i>[${teamName}] ${teamScore}</i>` // Italicize matching team
                    : `[${teamName}] ${teamScore}`;
                return formattedTeam;
            });

            return `R${raceNumber} | ${teamScores.join(" | ")}`;
        }

        function renderFormattedData(formattedData) {
            const tableContainer = document.getElementById("player-stats");
            tableContainer.innerHTML = formattedData;
        }

        // Listen for updates from the config page via BroadcastChannel
        const channel = new BroadcastChannel("table_config_channel");
        channel.addEventListener("message", (event) => {
            const { name, tableid } = event.data;
            const urlParams = new URLSearchParams(window.location.search);

            // Update the URL only if the 'name' matches
            if (urlParams.get("name") === name) {
                urlParams.set("tableid", tableid);
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState(null, "", newUrl);

                // Fetch and render the new data
                fetchAndRenderData();
            }
        });

        // Fetch data immediately on page load
        document.addEventListener("DOMContentLoaded", fetchAndRenderData);

        // Automatically fetch and update the data every 5 seconds
        setInterval(fetchAndRenderData, 5000);
    </script>
</body>
</html>
